@page "/"
@using System.Net.Http.Json
@inject HttpClient Http
@inject NavigationManager Nav
@inject IJSRuntime JS

<div class="weather-page @(isDarkTheme ? "dark-theme" : "light-theme")">

    <!-- ğŸ” TOP NAV -->
    <div class="d-flex justify-content-between align-items-center p-3">
        <div>
            <button class="btn btn-outline-secondary"
                    @onclick="ToggleTheme">
                @(isDarkTheme ? "â˜€ï¸ Light" : "ğŸŒ™ Dark")
            </button>
        </div>

        <div>
            <button class="btn btn-outline-primary me-2"
                    @onclick='() => Nav.NavigateTo("/login")'>
                Login
            </button>

            <button class="btn btn-primary"
                    @onclick='() => Nav.NavigateTo("/register")'>
                Register
            </button>
        </div>
    </div>

    <!-- â˜ï¸ Clouds -->
    <img src="/images/cloud1.png" class="cloud cloud1" />
    <img src="/images/cloud1.png" class="cloud cloud2" />
    <img src="/images/cloud1.png" class="cloud cloud3" />

    <h2 class="text-center mt-1 fw-bold">ğŸŒ¦ Weather Info (Guest Mode)</h2>
    <p class="text-center text-muted">
        You can search 3 times. Register to unlock full access.
    </p>

    <!-- ğŸ” Search Bar -->
    <div class="text-center mb-4 mt-3">
        <input @bind="cityQuery"
               placeholder="Search city..."
               class="form-control w-50 d-inline-block shadow-sm" />

        <button class="btn btn-success ms-2"
                @onclick="SearchCity">
            Search
        </button>
    </div>

    <!-- ğŸš« Limit Message -->
    @if (searchLimitReached)
    {
        <p class="text-center text-danger fw-bold fs-5">
            You reached 3 searches.
            Please <a href="/register">Register</a> to continue.
        </p>
    }

    <!-- ğŸŒ¦ Weather Result -->
    @if (isLoading)
    {
        <p class="text-center fs-5 mt-4 loader">Loading weather...</p>
    }
    else if (dailyForecasts.Count == 0 && !string.IsNullOrEmpty(cityQuery))
    {
        <p class="text-center text-danger fs-5">No data found.</p>
    }
    else
    {
        @if (dailyForecasts.Count > 0)
        {
            <div class="card shadow p-3 mb-4 weather-card text-center">
                <h4>ğŸ“ @locationName</h4>
            </div>

            <div class="d-flex justify-content-center flex-wrap">
                @foreach (var day in dailyForecasts)
                {
                    <div class="card forecast-card text-center m-2 p-3 shadow">
                        <h6 class="fw-bold">@day.Date</h6>
                        <img src="@day.IconUrl" width="60" />
                        <p class="mb-1 fw-bold">@day.TempÂ°C</p>
                        <p class="mb-0">@day.Condition</p>
                    </div>
                }
            </div>
        }
    }
</div>

@code {
    // ğŸŒ— Theme
    private bool isDarkTheme = false;

    private void ToggleTheme()
    {
        isDarkTheme = !isDarkTheme;
    }

    // ğŸ” Weather
    private string cityQuery = "";
    private string locationName = "";
    private bool isLoading = false;

    // ğŸš« Guest limit
    private int searchCount = 0;
    private bool searchLimitReached = false;

    private List<DailyForecast> dailyForecasts = new();

    protected override async Task OnInitializedAsync()
    {
        searchCount = await JS.InvokeAsync<int>("guestSearch.getCount");

        if (searchCount >= 3)
            searchLimitReached = true;
    }

    private async Task SearchCity()
    {
        if (searchLimitReached || string.IsNullOrWhiteSpace(cityQuery))
            return;

        searchCount++;
        await JS.InvokeVoidAsync("guestSearch.setCount", searchCount);

        if (searchCount > 3)
        {
            searchLimitReached = true;
            return;
        }

        await LoadWeather(cityQuery);
    }

    private async Task LoadWeather(string city)
    {
        isLoading = true;
        dailyForecasts.Clear();

        var apiKey = "204e204da512978d1e87ec668635580f";
        var url = $"https://api.openweathermap.org/data/2.5/forecast?q={city}&appid={apiKey}&units=metric";

        try
        {
            var data = await Http.GetFromJsonAsync<WeatherResponse>(url);

            if (data != null)
            {
                dailyForecasts = data.list
                    .Where(x => DateTime.Parse(x.dt_txt).Hour == 12)
                    .Take(3) // Guest: 3 days
                    .Select(x => new DailyForecast
                    {
                        Date = DateTime.Parse(x.dt_txt).ToString("dd MMM"),
                        Temp = x.main.temp,
                        Condition = x.weather.First().main!,
                        IconUrl = $"https://openweathermap.org/img/wn/{x.weather.First().icon}@2x.png"
                    }).ToList();

                locationName = $"{data.city.name} ({data.city.country})";
            }
        }
        catch
        {
            dailyForecasts.Clear();
        }

        isLoading = false;
    }

    // ğŸ“¦ Models
    public class WeatherResponse
    {
        public List<WeatherList> list { get; set; } = new();
        public City city { get; set; } = new();
    }

    public class City
    {
        public string name { get; set; } = "";
        public string country { get; set; } = "";
    }

    public class WeatherList
    {
        public MainData main { get; set; } = new();
        public List<WeatherDescription> weather { get; set; } = new();
        public string dt_txt { get; set; } = "";
    }

    public class MainData { public double temp { get; set; } }

    public class WeatherDescription
    {
        public string? main { get; set; }
        public string? icon { get; set; }
    }

    public class DailyForecast
    {
        public string Date { get; set; } = "";
        public double Temp { get; set; }
        public string Condition { get; set; } = "";
        public string IconUrl { get; set; } = "";
    }
}
