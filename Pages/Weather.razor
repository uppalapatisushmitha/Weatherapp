@page "/weather"
@using System.Net.Http.Json
@inject HttpClient Http

<div class="weather-page">

    <!-- Animated Clouds (Parallax) -->
    <img src="/images/cloud1.png" class="cloud cloud1" />
    <img src="/images/cloud1.png" class="cloud cloud2" />
    <img src="/images/cloud1.png" class="cloud cloud3" />

    <h3 class="text-center mt-3 text-light">🌦 5-Day Weather Forecast</h3>

    <div class="text-center mb-4">
        <input @bind="cityQuery" placeholder="Search city..."
               class="form-control w-50 d-inline-block shadow-sm" />
        <button class="btn btn-gradient ms-2" @onclick="SearchCity">Search</button>
    </div>

    @if (isLoading)
    {
        <p class="text-center fs-5 mt-4 loader">Loading weather...</p>
    }
    else if (dailyForecasts == null || !dailyForecasts.Any())
    {
        <p class="text-center text-danger fs-5">No data found.</p>
    }
    else
    {
        <div class="card shadow p-3 mb-4 weather-card text-center">
            <h4>📍 @locationName</h4>
        </div>

        <div class="d-flex justify-content-center flex-wrap">
            @foreach (var day in dailyForecasts)
            {
                <div class="card forecast-card text-center m-2 p-3 shadow">
                    <h6 class="fw-bold">@day.Date</h6>
                    <img src="@day.IconUrl" width="60" />
                    <p class="mb-1 fw-bold">@day.Temp°C</p>
                    <p class="text-light mb-0">@day.Condition</p>
                </div>
            }
        </div>
    }
</div>

@code {
    private string cityQuery = "";
    private string locationName = "";
    private bool isLoading = true;

    private List<DailyForecast> dailyForecasts = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadWeatherByAutoLocation();
    }

    private async Task LoadWeatherByAutoLocation()
    {
        try
        {
            var geo = await Http.GetFromJsonAsync<GeoResponse>("https://ipapi.co/json");
            locationName = geo?.city ?? "";
            await LoadWeather(locationName);
        }
        catch
        {
            isLoading = false;
        }
    }

    private async Task LoadWeather(string city)
    {
        isLoading = true;
        var apiKey = "204e204da512978d1e87ec668635580f";
        var url = $"https://api.openweathermap.org/data/2.5/forecast?q={city}&appid={apiKey}&units=metric";

        try
        {
            var data = await Http.GetFromJsonAsync<WeatherResponse>(url);

            if (data != null)
            {
                var list = data.list ?? new List<WeatherList>();
                dailyForecasts = list
                    .Where(x => DateTime.TryParse(x.dt_txt, out var dt) && dt.Hour == 12)
                    .Take(5)
                    .Select(x => new DailyForecast
                    {
                        Date = DateTime.TryParse(x.dt_txt, out var d) ? d.ToString("dd MMM yyyy") : x.dt_txt,
                        Temp = x.main?.temp ?? 0,
                        Condition = x.weather?.FirstOrDefault()?.description ?? "",
                        IconUrl = x.weather?.FirstOrDefault()?.icon == null
                            ? ""
                            : $"https://openweathermap.org/img/wn/{x.weather?.FirstOrDefault()?.icon}@2x.png"
                    }).ToList();

                locationName = data.city.name + " (" + data.city.country + ")";
            }
        }
        catch
        {
            dailyForecasts = new List<DailyForecast>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SearchCity()
    {
        if (!string.IsNullOrWhiteSpace(cityQuery))
        {
            await LoadWeather(cityQuery);
        }
    }

    public class GeoResponse { public string? city { get; set; } }

    public class WeatherResponse
    {
        public List<WeatherList>? list { get; set; }
        public City city { get; set; } = new City();
    }

    public class City
    {
        public string name { get; set; } = "";
        public string country { get; set; } = "";
    }

    public class WeatherList
    {
        public MainData main { get; set; } = new MainData();
        public List<WeatherDescription> weather { get; set; } = new List<WeatherDescription>();
        public string dt_txt { get; set; } = "";
    }

    public class MainData { public double temp { get; set; } }

    public class WeatherDescription
    {
        public string? description { get; set; }
        public string? icon { get; set; }
    }

    public class DailyForecast
    {
        public string Date { get; set; } = "";
        public double Temp { get; set; }
        public string Condition { get; set; } = "";
        public string IconUrl { get; set; } = "";
    }
}
