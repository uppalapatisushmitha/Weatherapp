@page "/weather"
@using System.Net.Http.Json
@inject HttpClient Http

<div class="weather-page @(isDarkTheme ? "dark-theme" : "light-theme")">

    <!-- Theme Toggle -->
    <div class="text-end mb-3">
        <button class="btn btn-sm btn-outline-secondary"
                @onclick="ToggleTheme">
            @(isDarkTheme ? "☀️ Light Mode" : "🌙 Dark Mode")
        </button>
    </div>

    <!-- Animated Clouds -->
    <img src="/images/cloud1.png" class="cloud cloud1" />
    <img src="/images/cloud1.png" class="cloud cloud2" />
    <img src="/images/cloud1.png" class="cloud cloud3" />

    <!-- Top Cities -->
    <h4 class="text-center mt-4 fw-bold">🌍 Top 5 Global Cities</h4>

    <div class="d-flex justify-content-center flex-wrap mt-3 mb-4">
        @if (topCitiesWeather.Count == 0)
        {
            <p>Loading global cities...</p>
        }
        else
        {
            @foreach (var city in topCitiesWeather)
            {
                <div class="card text-center m-2 p-3 shadow-sm city-card">
                    <h6 class="fw-bold">@city.CityName</h6>
                    <img src="@city.IconUrl" width="50" />
                    <p class="mb-1 fw-bold">@city.Temp°C</p>
                    <p class="mb-0">@city.Condition</p>
                </div>
            }
        }
    </div>

    <h3 class="text-center mt-3">🌦 5-Day Weather Forecast</h3>

    <!-- Search -->
    <div class="text-center mb-4">
        <input @bind="cityQuery"
               placeholder="Search city..."
               class="form-control w-50 d-inline-block" />
        <button class="btn btn-gradient ms-2" @onclick="SearchCity">
            Search
        </button>
    </div>

    <!-- Weather -->
    @if (isLoading)
    {
        <p class="text-center loader">Loading weather...</p>
    }
    else if (!dailyForecasts.Any())
    {
        <p class="text-center text-danger">No data found.</p>
    }
    else
    {
        <div class="card weather-card text-center mb-4">
            <h4>📍 @locationName</h4>
        </div>

        <div class="d-flex justify-content-center flex-wrap">
            @foreach (var day in dailyForecasts)
            {
                <div class="card forecast-card text-center m-2">
                    <h6>@day.Date</h6>
                    <img src="@day.IconUrl" width="60" />
                    <p class="fw-bold">@day.Temp°C</p>
                    <p>@day.Condition</p>
                </div>
            }
        </div>
    }
</div>

@code {
    private bool isDarkTheme = false;
    private string cityQuery = "";
    private string locationName = "";
    private bool isLoading = true;

    private List<DailyForecast> dailyForecasts = new();
    private List<CityWeather> topCitiesWeather = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadWeatherByAutoLocation();
        await LoadTopCitiesWeather();
    }

    private void ToggleTheme()
    {
        isDarkTheme = !isDarkTheme;
    }

    private async Task LoadWeatherByAutoLocation()
    {
        try
        {
            var geo = await Http.GetFromJsonAsync<GeoResponse>("https://ipapi.co/json");
            locationName = geo?.city ?? "";
            await LoadWeather(locationName);
        }
        catch
        {
            isLoading = false;
        }
    }

    private async Task LoadWeather(string city)
    {
        isLoading = true;
        var apiKey = "204e204da512978d1e87ec668635580f";
        var url = $"https://api.openweathermap.org/data/2.5/forecast?q={city}&appid={apiKey}&units=metric";

        try
        {
            var data = await Http.GetFromJsonAsync<WeatherResponse>(url);
            var list = data?.list ?? new();

            dailyForecasts = list
                .Where(x => DateTime.TryParse(x.dt_txt, out var d) && d.Hour == 12)
                .Take(5)
                .Select(x => new DailyForecast
                {
                    Date = DateTime.Parse(x.dt_txt).ToString("dd MMM"),
                    Temp = x.main.temp,
                    Condition = x.weather.First().description!,
                    IconUrl = $"https://openweathermap.org/img/wn/{x.weather.First().icon}@2x.png"
                }).ToList();

            locationName = $"{data?.city.name}, {data?.city.country}";
        }
        catch
        {
            dailyForecasts.Clear();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SearchCity()
    {
        if (!string.IsNullOrWhiteSpace(cityQuery))
            await LoadWeather(cityQuery);
    }

    private async Task LoadTopCitiesWeather()
    {
        var cities = new[] { "New York", "London", "Tokyo", "Paris", "Sydney" };
        var apiKey = "204e204da512978d1e87ec668635580f";

        foreach (var city in cities)
        {
            var url = $"https://api.openweathermap.org/data/2.5/weather?q={city}&appid={apiKey}&units=metric";
            var data = await Http.GetFromJsonAsync<CurrentWeatherResponse>(url);

            topCitiesWeather.Add(new CityWeather
            {
                CityName = $"{data!.name}, {data.sys.country}",
                Temp = data.main.temp,
                Condition = data.weather.First().main!,
                IconUrl = $"https://openweathermap.org/img/wn/{data.weather.First().icon}@2x.png"
            });
        }
    }

    public class GeoResponse { public string? city { get; set; } }

    public class WeatherResponse
    {
        public List<WeatherList> list { get; set; } = new();
        public City city { get; set; } = new();
    }

    public class WeatherList
    {
        public MainData main { get; set; } = new();
        public List<WeatherDescription> weather { get; set; } = new();
        public string dt_txt { get; set; } = "";
    }

    public class MainData { public double temp { get; set; } }

    public class WeatherDescription
    {
        public string? description { get; set; }
        public string? icon { get; set; }
        public string? main { get; set; }
    }

    public class City { public string name { get; set; } = ""; public string country { get; set; } = ""; }

    public class DailyForecast
    {
        public string Date { get; set; } = "";
        public double Temp { get; set; }
        public string Condition { get; set; } = "";
        public string IconUrl { get; set; } = "";
    }

    public class CityWeather
    {
        public string CityName { get; set; } = "";
        public double Temp { get; set; }
        public string Condition { get; set; } = "";
        public string IconUrl { get; set; } = "";
    }

    public class CurrentWeatherResponse
    {
        public string name { get; set; } = "";
        public Sys sys { get; set; } = new();
        public MainData main { get; set; } = new();
        public List<WeatherDescription> weather { get; set; } = new();
    }

    public class Sys { public string country { get; set; } = ""; }
}
