@page "/weather"
@inject IJSRuntime JS
@inject HttpClient Http
@using System.Net.Http.Json

<h2 class="text-center mt-4">🌤️ Weather Forecast</h2>
<p class="text-center text-muted mb-4">
    Auto-detected location. 5-day forecast below.
</p>

@if (loading)
{
    <div class="loader text-center fw-bold mt-4">Detecting your location...</div>
}
else if (errorMessage != null)
{
    <div class="alert alert-danger text-center">@errorMessage</div>
}
else
{
    <div class="card weather-card shadow-lg p-3 mb-4">
        <h4 class="fw-bold text-primary mb-1">📍 @cityName (@countryCode)</h4>
        <p class="text-muted mb-0">
            Coordinates: <b>@latitude</b> , <b>@longitude</b>
        </p>
    </div>

    <table class="table table-hover table-striped custom-table shadow">
        <thead class="table-primary">
            <tr>
                <th>Date</th>
                <th>Temp (°C)</th>
                <th>Feels Like</th>
                <th>Weather</th>
                <th>Humidity</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in forecastList)
            {
                <tr>
                    <td>@item.dt_txt.Split(" ")[0]</td>
                    <td>@item.main.temp</td>
                    <td>@item.main.feels_like</td>
                    <td>
                        <img src=@($"https://openweathermap.org/img/wn/{item.weather[0].icon}.png")
                             width="40" class="me-2" />
                        @item.weather[0].description
                    </td>
                    <td>@item.main.humidity %</td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    bool loading = true;
    string? errorMessage;
    double latitude;
    double longitude;
    string cityName = "";
    string countryCode = "";

    List<WeatherItem> forecastList = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var location = await JS.InvokeAsync<LocationData>("getUserLocation");
            latitude = location.latitude;
            longitude = location.longitude;

            string apiKey = "204e204da512978d1e87ec668635580f";

            string url =
                $"https://api.openweathermap.org/data/2.5/forecast?lat={latitude}&lon={longitude}&units=metric&appid={apiKey}";

            var data = await Http.GetFromJsonAsync<WeatherResponse>(url);

            if (data != null)
            {
                cityName = data.city.name;
                countryCode = data.city.country;

                // ✅ filter for daily forecast (12:00 only)
                forecastList = data.list
                    .Where(x => x.dt_txt.Contains("12:00:00"))
                    .Take(5)
                    .ToList();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Unable to fetch weather data: {ex.Message}";
        }

        loading = false;
    }

    public class LocationData
    {
        public double latitude { get; set; }
        public double longitude { get; set; }
    }

    public class WeatherResponse
    {
        public City city { get; set; } = new City();
        public List<WeatherItem> list { get; set; } = new List<WeatherItem>();
    }

    public class City
    {
        public string name { get; set; } = "";
        public string country { get; set; } = "";
    }

    public class WeatherItem
    {
        public Main main { get; set; } = new Main();
        public List<WeatherDesc> weather { get; set; } = new List<WeatherDesc>();
        public string dt_txt { get; set; } = "";
    }

    public class Main
    {
        public float temp { get; set; }
        public float feels_like { get; set; }
        public int humidity { get; set; }
    }

    public class WeatherDesc
    {
        public string description { get; set; } = "";
        public string icon { get; set; } = "";
    }
}
